---
title: clerkMiddleware() | Next.js
description: The `clerkMiddleware()` function allows you to protect your Next.js application using Middleware.
---

# `clerkMiddleware()`

The `clerkMiddleware()` helper integrates Clerk authentication into your Next.js application through Middleware. `clerkMiddleware()` is compatible with both the App and Pages routers. 

## Configure `clerkMiddleware()` and protect all routes in your application

Create a `middleware.ts` file. If your application uses the `src/` directory, your `middleware.ts` file should be placed inside the `src/` folder. If you are not using a `src/` directory, place the `middleware.ts` file in your root directory. 

<Callout level="info">
For more information about Middleware in Next.js applications, see the [Next.js documentation](https://nextjs.org/docs/pages/building-your-application/routing/middleware).
</Callout>

```tsx filename="middleware.ts"
import { clerkMiddleware } from '@clerk/nextjs/server';

export default clerkMiddleware()

export const config = {
  matcher: ['/((?!.*\\..*|_next).*)', '/', '/(api|trpc)(.*)'],
};
```

The basic Middleware will protect all routes in your application. With the recommended matcher written above, all routes are matched by Clerk's authentication Middleware, with the exception of internal `/_next/` routes and static files. Static files are detected by matching on paths that end in `.+\..+`. 

If you want to protect only certain routes, you can pass a matcher to `clerkMiddleware()`. The matcher is an array of paths that you want to protect. 

{/* Throw this in a callout because it is referencing a previous version/feature, so it is supplemental information. */}
<Callout type="warning">
  The new `clerkMiddleware()` behaves in the opposite manner from the previous `authMiddleware()` that Clerk shipped with version 4 of our SDKs. With `clerkMiddleware()`, all routes are now public and you must opt-in to protection for routes.
</Callout>

## `clerkMiddleware()` and Environment Variables

{/* Does clerkMiddleware() also accept a publicRoutes option?? */}
If you are building your own sign in pages, you don't need to add these pages to your `publicRoutes`. They will be inferred from your `.env` file:

```ts filename=".env"
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/
```

## Protect routes with `createRouteMatcher()` and `clerkMiddleware()`

{/* Questions:
- can you pass an empty array and it will protect all routes?
- can you pass a single route in the array, and it protects just one single route? */}

`createRouteMatcher()` is a Clerk helper function that allows you to protect multiple routes. `createRouteMatcher()` accepts an array of routes and checks if the route the user is trying to visit matches one of the routes passed to it. The paths provided to this helper can be in the same format as the paths provided to the Next Middleware matcher. 

In the following example, a `isProtectRoute()` helper is created where the routes `/dashboard(.*)` and `/forum(.*)` are passed to `createRouteMatcher()`. The `isProtectedRoute()` helper is then used in the Middleware logic to check if the user is trying to access one of the protected routes. If the route is protected, `auth().protect()` will check if a user is signed in (authenticated). If they are not authenticated, the user will be redirected to sign in.

```tsx filename="middleware.ts"
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';

const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
  '/forum(.*)',
]);

export default clerkMiddleware(
  (auth, req) => {
    if (isProtectedRoute(req)) {
      auth().protect();
    }
  }
);

export const config = {
  matcher: ['/((?!.*\\..*|_next).*)', '/', '/(api|trpc)(.*)'],
};
```

### Protect multiple groups of routes with `createRouteMatcher()` and `clerkMiddleware()`

You can use more than one `createRouteMatcher()` in your application if you have two or more groups of routes.

```tsx filename="middleware.ts" 
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';

const isTenantRoute = createRouteMatcher([
  '/organization-selector',
  '/orgid/(.*)'
])

const isTenentAdminRoute = createRouteMatcher([
  '/orgId/(.*)/mememberships',
  '/orgId/(.*)/domain',
]);

export default clerkMiddleware(
  (auth, req) => {
    // restrict admin routes to users with specific permissions 
    if (isTenantAdminRoute(req)) {
      auth().protect(has => has({permission: 'org:sys_memberships:manage'}) || has({permissions: 'org:sys_domains_manage'}))
    }
    // restrict organiztion routes to logged in users
    if (isTenantRoute(req)) {
      auth().protect();
    }
  }
);

export const config = {
  matcher: ['/((?!.*\\..*|_next).*)', '/', '/(api|trpc)(.*)'],
};
```

<Callout type="info">
  The example above uses the `has()` method from Clerk's `auth()` helper. `has()` is a low level method that allows you to check if a user has a specific role or permission. For more information, see the [has() documentation](/docs/references/nextjs/auth#authorization-with-has).
</Callout>

{/* TODO: So below this line, clerkMiddleware() is not being used. But I see that auth() is being used a lot. So do we need to create another guide, or do we need to move this information into the auth() docs, or what? */}

## Protect routes with `redirectToSignIn()`

You can also protect routes in your application by utilizing the `redirectToSignIn()` method. This method will redirect the user to the sign in page.

`redirectToSignIn()` is a low level version of `protect()`.

The following example would protect your entire application and redirect the user to sign in if they are not authenticated.

```tsx filename="middleware.tsx"
if (!auth().userId) { 
  return auth().redirectToSignIn()
}
```

{/* TODO: Can you protect a specific route with this method, or only the entire application? */}

## Protect routes with `protect()`

The `protect()` method from `auth()` allows you to protect a route based on whether they are authenticated or not. 

The following example would require the user to be signed in. If they are not authenticated, `protect()` will redirect the user to sign in.

```tsx filename="middleware.tsx"
if (protectedRoute(req)) { 
  auth().protect()
}
```

### Protect routes based on roles or permissions with `protect()`

You can also use the `protect()` method to protect a route based on a user's role or permissions.

The following example would restrict the `/dashboard` and `/forum` routes to users with the specified permission, which in this case is `org:sys_profile:delete`. 

```tsx filename="middleware.ts" {9}
import { createRouteMatcher } from '@clerk/nextjs/server';

const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
  '/forum(.*)',
]);

if (isProtectedRoute(req)) { 
  auth().protect({ permission: "org:sys_profile:delete" })
}
```

The following would restrict the `/dashboard` and `/forum` routes to users with the specified role, which in this case is `org:admin`.

```tsx filename="middleware.ts" {9}
import { createRouteMatcher } from '@clerk/nextjs/server';

const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
  '/forum(.*)',
]);

if (isProtectedRoute(req)) { 
  auth().protect({ role: "org:admin" })
}
```

### Protect routes with `protect()` and redirect users to a specific URL

`protect()` accepts an optional `redirectUrl` parameter. If the user is not authenticated, they will be redirected to the URL specified in `redirectUrl`.

The following example would redirect the user to `/subscribe` if they are visiting a `/dashboard` route and are not authenticated.

```tsx filename="middleware.tsx"
import { createRouteMatcher } from '@clerk/nextjs/server';

const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
]);

if (isProtectedRoute(req)) { 
  auth().protect({ redirectUrl: "/subscribe" })
}
```

The following example would redirect the user to `/org-selector` if they are visiting a `/dashboard` route and do not have the `org:admin` role.

```tsx filename="middleware.tsx"
import { createRouteMatcher } from '@clerk/nextjs/server';

const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
]);

if (isProtectedRoute(req)) { 
  auth().protect({ role: "org:admin" }, { redirectUrl: "/org-selector" })
}
```

## Debug your middleware

If you are having issues getting your Middleware dialed in, or are trying to narrow down auth-related issues, you can use the debugging feature in `clerkMiddlware()`. Add `{ debug: true }` to `clerkMiddlware()` and you will get debug logs in your terminal.

```tsx filename="middleware.ts" {6}
import { clerkMiddleware } from '@clerk/nextjs/server';

export default clerkMiddleware(
  (auth, req) => {
    // Your middleware checks
  }, { debug: true })

export const config = {
  matcher: ['/((?!.*\\..*|_next).*)', '/', '/(api|trpc)(.*)'],
};
```

## Combining Middleware

You can combine other Middleware with Clerk's by calling the second Middleware from inside of `clerkMiddleware()`. 

```js filename="middleware.ts" 
import {
  clerkMiddleware,
  createRouteMatcher,
  redirectToSignIn,
} from '@clerk/nextjs/server';
import createMiddleware from 'next-intl/middleware';

import { AppConfig } from './utils/AppConfig';

const intlMiddleware = createMiddleware({
  locales: AppConfig.locales,
  localePrefix: AppConfig.localePrefix,
  defaultLocale: AppConfig.defaultLocale,
});

const isProtectedRoute = createRouteMatcher([
  'dashboard/(.*)',
]);

export default clerkMiddleware(
  (auth, req) => {
    if (!auth().userId && isProtectedRoute(req)) {
      return redirectToSignIn({ returnBackUrl: req.url });
    }
    return intlMiddleware(req);
  }
);

export const config = {
  matcher: ['/((?!.+\\.[\\w]+$|_next).*)', '/', '/(api|trpc)(.*)'],
};
```

## Options

The `clerkMiddleware()` function accepts an optional object. The following options are available:

| Name                               | Type                 | Description                                                                                                                                                                                                                                                                                                                                     |
| ---------------------------------- | -------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `audience?`                        | `string \| string[]` | A string or list of [audiences](https://datatracker.ietf.org/doc/html/rfc7519#section-4.1.3). If passed, it is checked against the `aud` claim in the token.                                                                                                                                                                                    |
| `authorizedParties?`               | `string[]`           | An allowlist of origins to verify against, to protect your application from the subdomain cookie leaking attack.<br/>For example:<br/>`['http://localhost:3000', 'https://example.com']`<br/>For more information, refer to the [reference guide](/docs/references/nodejs/token-verification#validate-the-authorized-party-of-a-session-token). |
| `clockSkewInMs?` | `number`             | Specifies the allowed time difference (in milliseconds) between the Clerk server (which generates the token) and the clock of the user's application server when validating a token. Defaults to 5000 ms (5 seconds).                                                                                                                                                                                                                                                                                                         |
| `domain?`                          | `string`             | The domain used for satellites to inform Clerk where this application is deployed.                                                                                                                                                                                                                                                              |
| `isSatellite?`                     | `boolean`            | When using Clerk's satellite feature, this should be enabled for secondary domains.                                                                                                                                                                                                                                                             |
| `jwtKey?`                          | `string`             | An optional [custom JWT key](/docs/references/nodejs/token-verification#networkless-token-verification-using-the-jwt-verification-key) to use for session token validation.                                                                                                                                                                     |
| `onError?`                       | callback function             | A callback function to handle errors from the Middleware.                                                                                                                                                                                                                                                                                                                    |
| `proxyUrl?`                        | `string`             | If using a proxy, specify the URL of the proxy.                                                                                                                                                                                                                                                                                                 |
| `signInUrl?`                       | `string`             | An alternative sign in URL.                                                                                                                                                                                                                                                                                                                     |
| `strict?`                       | `boolean`             |                                                                                                                                                                                                                                                                                                                     |



